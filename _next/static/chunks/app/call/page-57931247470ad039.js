(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2293],{93658:function(e,t,n){Promise.resolve().then(n.bind(n,81807))},81807:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return V}});var s=n(57437),l=n(2265),i=n(74272),a=n(53974),o=n(14438),r=n(99376),c=n(89403);function d(e){let{children:t}=e,n=(0,a.useIsClient)(),{token:l}=(0,c.f)(),d=(0,r.useSearchParams)().get("session_id");return d?n?(0,s.jsx)(i.eA,{url:"".concat("wss://backend-us-yc.tenmin.ai","/ws/lesson/").concat(d,"?token=").concat(l),label:"Call",toast:o.A,autoconnect:!0,wsAuth:!0,binaryType:"arraybuffer",children:t}):null:(0,s.jsx)("div",{children:"Invalid lesson"})}var u=n(5095),x=n(60755),m=n(19764);n(7354),n(76889);var f=n(73377),h=n(49677),p=n(63399),g=n(15123),v=n(1755),j=n(80434),y=n(61273),b=n(3069),w=n(22744),N=n(32859);let T=e=>{var t,n;let{isOpen:i,onClose:a,detailedTranslation:o,isTTSPlaying:r,onTTSPlay:c,isPracticeRecording:d,setPracticeRecording:u,isPracticePlaying:x,setPracticePlaying:m,onSave:f,isSaved:h}=e,p=null!==(t=null==o?void 0:o.wordForWord)&&void 0!==t?t:[],g=null!==(n=null==o?void 0:o.translation)&&void 0!==n?n:"",[v,j]=(0,l.useState)(null);return(0,s.jsxs)(b.y,{isOpen:i,onClose:()=>{a(),j(null)},detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,s.jsx)(b.y.Container,{children:(0,s.jsx)(b.y.Content,{style:{backgroundImage:"white"},children:(0,s.jsxs)("div",{className:"w-full p-8 pb-16 text-black",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-lg font-semibold",children:"Explanation"}),(0,s.jsxs)("div",{className:"flex gap-0",children:[void 0!==f&&(0,s.jsx)("button",{className:"p-2",onClick:()=>{f(null!=h&&h)},children:h?(0,s.jsx)(y.VF9,{}):(0,s.jsx)(y.mCg,{})}),(0,s.jsx)("button",{className:"p-2 text-lg",onClick:()=>{a(),j(null)},children:(0,s.jsx)(y._0w,{})})]})]}),(0,s.jsx)("div",{className:"mt-4 flex flex-wrap gap-1 gap-y-2",children:p.length>0&&p.map((e,t)=>(0,s.jsxs)("div",{className:"flex flex-col items-center rounded ".concat(v===t?"bg-[#0039FF]/10 text-[#0039FF]":"bg-black/5"),onClick:()=>{let n=e.original.trim();RegExp("^\\p{P}+$","u").test(n)||(c(n),j(t))},children:[(0,s.jsx)("div",{className:"text-nowrap px-1 text-xl font-normal",children:e.original}),(0,s.jsx)("div",{className:"text-nowrap px-1 text-sm opacity-50",children:e.translation})]},t))}),(0,s.jsxs)("div",{className:"mt-6 flex items-start gap-2 text-sm text-black/30",children:[(0,s.jsx)(w.mp2,{className:"flex-shrink-0 text-xl text-black/30"}),(0,s.jsx)("div",{children:g})]}),(0,s.jsxs)("div",{className:"mx-10 mt-10 flex justify-center gap-6",children:[(0,s.jsxs)("div",{className:"flex w-16 flex-1 flex-col items-center gap-2",children:[(0,s.jsx)("button",{onClick:()=>{c(),j(null)},className:"flex h-14 w-14 items-center justify-center rounded-full bg-white p-4 shadow-custom-blue-shadow",children:(0,s.jsx)(N.J,{className:"text-lg text-[#0039FF]",icon:r?y.JuG:y.gmG})}),(0,s.jsx)("div",{className:"text-sm",children:"Play"})]}),(0,s.jsxs)("div",{className:"flex w-16 flex-1 flex-col items-center gap-2",children:[(0,s.jsx)("button",{onClick:()=>u(!d),className:"flex h-14 w-14 items-center justify-center rounded-full bg-[#0039FF] p-4 shadow-custom-blue-shadow",children:(0,s.jsx)(N.J,{className:"text-xl text-white",icon:d?y.u9M:y.uYL})}),(0,s.jsx)("div",{className:"text-sm",children:"Practice"})]}),(0,s.jsxs)("div",{className:"flex w-16 flex-1 flex-col items-center gap-2",children:[(0,s.jsx)("button",{onClick:()=>m(!x),className:"flex h-14 w-14 items-center justify-center rounded-full bg-white p-4 shadow-custom-blue-shadow",children:(0,s.jsx)(y.tdo,{className:"text-xl text-[#0039FF]"})}),(0,s.jsx)("div",{className:"text-nowrap text-sm",children:"Your sound"})]})]})]})})}),(0,s.jsx)(b.y.Backdrop,{onTap:a})]})};var C=n(28529),k=n(49089),S=e=>{let{color:t="black"}=e;return(0,s.jsx)("svg",{width:"10",height:"16",viewBox:"0 0 10 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{d:"M0.0946622 2.84349C0.543847 1.57554 1.74925 0.722656 3.09681 0.722656H6.41168C8.39605 0.722656 9.99947 2.33176 9.99947 4.31045C9.99947 5.59546 9.31148 6.78381 8.19705 7.42631L6.36051 8.4782C6.34913 9.21737 5.74074 9.82007 4.99589 9.82007C4.23967 9.82007 3.63128 9.21168 3.63128 8.45546V7.68786C3.63128 7.19888 3.89283 6.74969 4.31927 6.5052L6.83812 5.06099C7.10536 4.90747 7.27025 4.62317 7.27025 4.31613C7.27025 3.83852 6.88361 3.45757 6.41168 3.45757H3.09681C2.90349 3.45757 2.73291 3.57697 2.67037 3.75892L2.64762 3.82715C2.39745 4.53788 1.61279 4.90747 0.907744 4.65729C0.202694 4.40711 -0.172574 3.62246 0.0776046 2.91741L0.100348 2.84918L0.0946622 2.84349ZM3.17641 13.459C3.17641 12.9765 3.36811 12.5137 3.70933 12.1725C4.05054 11.8312 4.51334 11.6396 4.99589 11.6396C5.47845 11.6396 5.94124 11.8312 6.28246 12.1725C6.62368 12.5137 6.81538 12.9765 6.81538 13.459C6.81538 13.9416 6.62368 14.4044 6.28246 14.7456C5.94124 15.0868 5.47845 15.2785 4.99589 15.2785C4.51334 15.2785 4.05054 15.0868 3.70933 14.7456C3.36811 14.4044 3.17641 13.9416 3.17641 13.459Z",fill:t})})};let A=e=>{let{isOpen:t,onClose:n,isVoiceDetected:i,selectedMic:a,acquireMic:o}=e,[r,c]=(0,l.useState)([]),d=async()=>{c((await navigator.mediaDevices.enumerateDevices()).filter(e=>"audioinput"===e.kind))};return(0,l.useEffect)(()=>{d(),navigator.mediaDevices&&void 0!==navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=d)},[]),(0,l.useEffect)(()=>{let e=setInterval(()=>{d()},1e3);return()=>clearInterval(e)},[]),(0,s.jsxs)(b.y,{isOpen:t,onClose:n,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,s.jsx)(b.y.Container,{style:{backgroundColor:"#FAFBFF"},children:(0,s.jsx)(b.y.Content,{children:(0,s.jsxs)("div",{className:"w-full p-8 pb-16 text-black",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-lg font-semibold",children:"Settings"}),(0,s.jsx)("div",{className:"flex gap-3",children:(0,s.jsx)("button",{onClick:n,children:(0,s.jsx)(y._0w,{})})})]}),(0,s.jsxs)("div",{className:"mt-6 flex flex-col gap-5",children:[(0,s.jsx)("div",{className:"flex items-center gap-2 text-black",children:(0,s.jsx)("p",{children:"Your Microphone"})}),(0,s.jsx)("div",{className:"flex flex-col gap-2",children:r.map(e=>(0,s.jsx)("button",{className:"flex w-full items-center justify-between rounded-lg border px-3 py-3 font-normal ".concat(a==e.deviceId?"border-[#0039FF] bg-[#0039FF]/5 text-[#0039FF]":"bg-white"),onClick:()=>{o(e.deviceId)},children:(0,s.jsx)("p",{className:"text-sm",children:e.label||"Unknown Microphone"})},e.deviceId))}),(0,s.jsxs)("div",{className:"mb-12 flex items-center gap-2 text-sm text-black/30",children:[(0,s.jsx)("p",{children:"Try speaking to test your microphone:"}),(0,s.jsx)("div",{className:"flex h-1 w-8 items-center justify-center rounded-full ".concat(i?"bg-green-500":"bg-black/10")})]})]})]})})}),(0,s.jsx)(b.y.Backdrop,{onTap:n})]})};var E=n(68171);let F=e=>{let{isOpen:t,onClose:n}=e;return(0,s.jsxs)(b.y,{isOpen:t,onClose:n,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,s.jsx)(b.y.Container,{style:{backgroundColor:"#FAFBFF"},children:(0,s.jsx)(b.y.Content,{children:(0,s.jsxs)("div",{className:"w-full p-8 pb-16 text-black",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("p",{className:"text-lg font-semibold",children:"Tips and tricks"}),(0,s.jsx)("div",{className:"flex gap-3",children:(0,s.jsx)("button",{onClick:n,children:(0,s.jsx)(y._0w,{})})})]}),(0,s.jsx)("div",{className:"mt-6 flex flex-col gap-5",children:(0,s.jsxs)("div",{className:"text-black",children:[(0,s.jsx)("p",{children:"Did you know that you can use your native language to ask questions?"}),(0,s.jsx)("p",{className:"mt-2 italic text-[#0039FF]/50",children:'E.g. "How do I say that I am traveling to Portugal soon?"'})]})})]})})}),(0,s.jsx)(b.y.Backdrop,{onTap:n})]})},_=e=>{let{isOpen:t,onClose:n,inputBar:l}=e;return(0,s.jsxs)(b.y,{isOpen:t,onClose:n,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},disableDrag:!0,children:[(0,s.jsxs)(b.y.Container,{style:{backgroundColor:"#FAFBFF",borderTopLeftRadius:"16px",borderTopRightRadius:"16px"},children:[(0,s.jsx)(b.y.Header,{}),(0,s.jsx)(b.y.Content,{children:(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center pb-16 pt-4",children:[(0,s.jsx)("p",{className:"text-lg font-semibold",children:"Speak again..."}),(0,s.jsx)("p",{className:"mb-6 mt-2 text-black/30",children:"Tap and hold the button"}),l]})})]}),(0,s.jsx)(b.y.Backdrop,{onTap:n})]})},R=e=>{let{isOpen:t,onClose:n,onQuit:l}=e;return(0,s.jsxs)(b.y,{isOpen:t,onClose:n,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,s.jsxs)(b.y.Container,{style:{backgroundColor:"#FAFBFF",borderTopLeftRadius:"16px",borderTopRightRadius:"16px"},children:[(0,s.jsx)(b.y.Header,{}),(0,s.jsx)(b.y.Content,{children:(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center px-7 pb-16 pt-4 text-center",children:[(0,s.jsx)("p",{className:"text-4xl font-semibold",children:"\uD83D\uDE2D"}),(0,s.jsx)("p",{className:"mt-4 text-lg font-medium",children:"Quit and you'll lose all XP gained in this lesson!"}),(0,s.jsx)("button",{className:"mt-8 flex w-full items-center justify-center rounded-full bg-[#2552F4] py-4 text-white",onClick:()=>{n()},children:(0,s.jsx)("p",{className:"text-base font-bold",children:"Keep learning"})}),(0,s.jsx)("button",{className:"mt-2 flex w-full items-center justify-center py-4 font-semibold text-red-600",onClick:()=>{l()},children:"Quit"})]})})]}),(0,s.jsx)(b.y.Backdrop,{onTap:n})]})};var D=n(16593),P=n(33344);let I=e=>{var t;let{isOpen:n,onClose:l,onFinish:i,streakPlus:o,xp:c,words:d,minutes:u,session_id:m}=e,f=(0,r.useRouter)(),[h,p]=(0,a.useLocalStorage)("language"),{data:g,isLoading:v}=(0,D.a)({...(0,P.rs)({query:{language:h}})}),j=Object.entries(g||{});j.length>0&&(null===(t=j[0][1])||void 0===t||t.streak);let w={hidden:{opacity:0,scale:.8},visible:{opacity:1,scale:1,transition:{duration:.5}}};return(0,s.jsxs)(b.y,{isOpen:n,onClose:l,detent:"content-height",tweenConfig:{ease:"easeInOut",duration:.3},children:[(0,s.jsxs)(b.y.Container,{style:{backgroundColor:"#FAFBFF",borderTopLeftRadius:"16px",borderTopRightRadius:"16px"},children:[(0,s.jsx)(b.y.Header,{}),(0,s.jsx)(b.y.Content,{children:(0,s.jsx)("main",{className:"flex flex-col bg-[#FAFBFF] pb-10 tracking-[-0.02em]",children:(0,s.jsxs)("div",{className:"flex h-full flex-col justify-between px-8",children:[(0,s.jsxs)("div",{className:"flex h-full flex-col items-center justify-center",children:[(0,s.jsxs)(x.E.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{duration:.3},className:"flex h-[10.75rem] flex-col items-center justify-center gap-5",children:[(0,s.jsx)(x.E.div,{initial:{y:-20},animate:{y:0},transition:{delay:.1,type:"spring",stiffness:300},className:"flex gap-2",children:[0,1,2].map(e=>(0,s.jsx)(x.E.div,{initial:{opacity:0,rotate:-180},animate:{opacity:1,rotate:0},transition:{delay:.1*e,duration:.3},children:(0,s.jsx)(y.QJe,{className:"text-4xl text-[#FFC800] ".concat(1==e&&"-translate-y-3")})},e))}),(0,s.jsx)(x.E.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4,duration:.3},className:"mt-2 text-center text-xl font-semibold",children:"Lesson complete!"})]},"encouragement"),(0,s.jsxs)("div",{className:"mt-0 grid w-full grid-cols-3 gap-2",children:[(0,s.jsxs)(x.E.div,{className:"flex flex-col items-center justify-center rounded-xl border-[1px] border-[#DADADA] bg-white py-4",variants:w,initial:"hidden",animate:"visible",children:[(0,s.jsx)(y.LkT,{className:"text-xl text-[#FFC800]"}),(0,s.jsx)("div",{className:"mt-2 text-lg font-medium",children:c}),(0,s.jsx)("div",{className:"text-xs text-black/30",children:"XP"})]}),(0,s.jsxs)(x.E.div,{className:"flex flex-col items-center justify-center rounded-xl border-[1px] border-[#DADADA] bg-white py-4",variants:w,initial:"hidden",animate:"visible",children:[(0,s.jsx)(y.ml,{className:"text-xl text-[#CD348E]"}),(0,s.jsx)("div",{className:"mt-2 text-lg font-medium",children:d}),(0,s.jsx)("div",{className:"text-xs text-black/30",children:"Words"})]}),(0,s.jsxs)(x.E.div,{className:"flex flex-col items-center justify-center rounded-xl border-[1px] border-[#DADADA] bg-white py-4",variants:w,initial:"hidden",animate:"visible",children:[(0,s.jsx)(y.qyc,{className:"text-xl text-[#34CD71]"}),(0,s.jsx)("div",{className:"mt-2 text-lg font-medium",children:u}),(0,s.jsx)("div",{className:"text-xs text-black/30",children:"Minutes"})]})]})]}),(0,s.jsx)("button",{className:"mt-8 flex w-full items-center justify-center rounded-full bg-[#2552F4] py-4 text-white",onClick:()=>{i(),m&&f.replace("/aftercare?session_id=".concat(m))},children:(0,s.jsx)("p",{className:"text-base font-semibold",children:"Finish lesson"})}),(0,s.jsx)("button",{className:"mt-2 flex w-full items-center justify-center py-4 font-semibold text-[#2552F4]",onClick:()=>{l()},children:"Continue conversation"})]})})})]}),(0,s.jsx)(b.y.Backdrop,{onTap:l})]})};var O=n(71059);let L=["end_call"];function M(){var e,t,n,o,c,d,b,w,C,k,D,P,M,V,W,G,U;let Y=(0,r.useSearchParams)().get("session_id"),H=(0,l.useRef)(null),Q=(0,l.useRef)(null),q=(0,l.useRef)(null),{startRecording:K,stopRecording:Z,playRecording:J,stopPlayback:z,isPracticeRecording:X,isPlayingAudio:$}=(0,v.I)(),[ee,et]=(0,l.useState)(0),[en,es]=(0,l.useState)(!1),[el,ei]=(0,l.useState)(!1);function ea(){ei(!0),setTimeout(()=>{ei(!1)},2500)}let[eo,er]=(0,l.useState)(0),[ec,ed]=(0,l.useState)(null),[eu,ex]=(0,l.useState)(""),[em,ef]=(0,l.useState)(null),[eh,ep]=(0,l.useState)(!1),eg=(0,r.useRouter)(),[ev,ej]=(0,l.useState)(!0),[ey,eb]=(0,l.useState)(!0),[ew,eN]=(0,l.useState)(!1),[eT,eC]=(0,l.useState)(null),[ek,eS]=(0,l.useState)(!1),[eA,eE]=(0,l.useState)(!1),[eF,e_]=(0,l.useState)(!1),eR=(0,l.useRef)(!1),[eD]=(0,i.tp)("AUDIO_CALL",(e,t)=>{"TUTOR_STOP_CALL"===t.type&&(console.log("Tutor scheduled finish"),eR.current=!0)},{status:"BACKEND_DISCONNECTED",mode:"Beginner",showStreakPlus:!1,xp:0,startTime:new Date().toISOString(),speedPreference:"NORMAL",lessonInfo:{},saved:[]}),eP=(0,i.MV)("STT",{requirePcm:void 0,totalTranscript:"",currTranscript:"",tempTranscript:""}),eI=(0,i.MV)("CHAT",{messages:[],userPreview:null,assistantPreview:null}),eO=(0,i.MV)("TTS",{volumeMultiplier:1}),[eL]=(0,l.useState)(1);(0,l.useEffect)(()=>((async()=>{try{await g.P.keepAwake()}catch(e){console.error("Failed to enable keep-awake",e)}})(),()=>{(async()=>{await g.P.allowSleep()})()}),[]);let{startSpeaker:eM,isPlaying:eB,latestAudioId:eV,latestCharIndex:eW,setLatestAudioId:eG}=(0,p.Z)({onPlaybackStart:e=>{eO.sendAction({type:"PLAYBACK_STARTED",id:e})},onPlaybackFinish:e=>{eO.sendAction({type:"PLAYBACK_FINISHED",id:e}),eR.current&&(console.log("Tutor scheduled finish confirmed"),e_(!0),eR.current=!1)},onPlaybackInterrupt:(e,t,n)=>{eO.sendAction({type:"PLAYBACK_INTERRUPTED",id:e,played_duration:t,latest_char_index:n})},volume:eO.volumeMultiplier,speed:eL}),eU=(e,t)=>void 0==e||null==eW?"":t?t.length>0?e.slice(0,eW*e.length/t.length):e:e.slice(0,eW),{isVoiceDetected:eY,isRecording:eH,isMuted:eQ,setMuted:eq,selectedMic:eK,startRecording:eZ,stopRecording:eJ,cancelRecording:ez,acquireMic:eX}=(0,h.Z)({onAudioData:e=>{if(!eP.requirePcm){if(0==e.byteLength){console.warn("Empty audio blob received");return}eP.sendBinary({type:"STREAM_MIC"},e)}},onPCMData(e){if(eP.requirePcm){if(0===e.byteLength){console.warn("Empty pcm data received");return}eP.sendBinary({type:"STREAM_PCM"},e)}},onRecordingStart:()=>{"Realtime"!=eD.mode&&eP.sendAction({type:"PTT_PRESSED"})},onRecordingStop:e=>{"Realtime"!=eD.mode&&(e?eP.sendAction({type:"PTT_CANCELLED"}):eP.sendAction({type:"PTT_RELEASED"}))},onSpeechStart:()=>{eP.sendAction({type:"VAD_CHANGED",detected:!0})},onSpeechEnd:()=>{eP.sendAction({type:"VAD_CHANGED",detected:!1})},startMuted:!1,recordingChunkSize:100}),e$=parseInt(null!==(U=null==eV?void 0:eV.slice(1))&&void 0!==U?U:"")>=eI.messages.length,e0=(0,l.useMemo)(()=>eI.messages.concat(eI.userPreview||[]).concat(eI.assistantPreview&&(e$||eI.assistantPreview.tool_calls)?eI.assistantPreview:[]),[eI.messages,eI.userPreview,eI.assistantPreview,e$]),e1=e0.findLastIndex(e=>"assistant"===e.role),e2=e0[e1],e3=e0.findLastIndex(e=>"user"===e.role),e4=e0.slice(0,e3),e5=e0.slice(e3),e6=e0.filter(e=>{var t,n,s;return"assistant"===e.role&&(null===(s=e.tool_calls)||void 0===s?void 0:null===(n=s[0])||void 0===n?void 0:null===(t=n.function)||void 0===t?void 0:t.name)&&!L.includes(e.tool_calls[0].function.name)}),e7=e6[e6.length-1],e8=(0,i.MV)("TRANSLATION",{wordForWord:{},translations:{}}),[e9]=(0,i.tp)("CORRECTION",(e,t)=>{if("PERFECT"===t.type){if("Advanced"!==eD.mode&&es(!0),!eB&&!eH&&!X){let e=new Audio("encouragement.mp3");e.volume=.5,e.play()}setTimeout(()=>{es(!1)},1200)}},{corrections:{}}),te=(0,i.MV)("AUTOCOMPLETE",{suggestions:[],translations:[],wordForWord:[],saved:[]}),[tt,{height:tn}]=(0,a.useMeasure)();(0,l.useEffect)(()=>{et(e0.length/12),1==ee&&"Smart"!==eD.mode&&e_(!0)},[e0]),(0,l.useEffect)(()=>{"Smart"==eD.mode&&ej(!1)},[eD.mode]),(0,l.useEffect)(()=>{"CONNECTED"!=eD.status&&"BACKEND_DISCONNECTED"!=eD.status&&(eh||(console.log("Auto starting lesson"),ep(!0),eM(()=>{eD.sendAction({type:"START_CALL"})},()=>{alert("Failed to start speaker")}),"Realtime"==eD.mode&&eZ(),eq(!1)))},[eD.status]),(0,l.useEffect)(()=>{console.log("Scrolling to latest message");let e=document.getElementById("latest-user-message");e&&e.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})},[e3]),(0,l.useEffect)(()=>{console.log("Scrolling to latest tool"),Q.current&&Q.current.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})},[null==e7?void 0:null===(n=e7.tool_calls)||void 0===n?void 0:null===(t=n[0])||void 0===t?void 0:null===(e=t.function)||void 0===e?void 0:e.name]),(0,l.useEffect)(()=>{e7&&(eS(!0),setTimeout(()=>{Q.current&&Q.current.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})},100))},[void 0===e7]);let[ts,tl]=(0,l.useState)(!1),ti={isPlaying:eB,latestAudioId:eV,sliceTTS:eU,isPreviewTTSPlaying:e$,startSpeaker:eM,tts:eO,translation:e8,audioCall:eD,correction:e9,viewText:ey,setExplainedOriginal:ex,setOpenedExplanation:er,setOpenedExplanationType:ed,setOnExplanationSave:ef,setRedoMessageIndex:eC};return(0,s.jsxs)("div",{className:"flex h-full flex-col items-center tracking-[-0.02em]",children:[(0,s.jsx)(u.M,{children:!el&&e0.length<2&&!ek&&(0,s.jsxs)(x.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3,delay:.3},className:"scrollbar-hide pointer-events-auto absolute bottom-36 flex w-full flex-nowrap justify-start gap-2 overflow-x-auto py-3",children:[(0,s.jsx)("div",{className:"w-2 flex-shrink-0"}),['Say "I have a question..."','"I want to learn vocab..."','"Help me practice pronunciation..."','"I want to practice something else..."',"..."].map((e,t)=>(0,s.jsx)("div",{className:"flex-shrink-0 rounded-lg bg-[#2552F4]/10 p-1.5 px-2 text-sm text-[#2552F4]/70",children:e},t)),(0,s.jsx)("div",{className:"w-2 flex-shrink-0"})]})}),(0,s.jsx)(T,{isOpen:null!==ec,onClose:()=>{er(0),ed(null),ef(null)},detailedTranslation:"message"===ec?{wordForWord:e8.wordForWord[eo],translation:e8.translations[eo]}:{wordForWord:te.wordForWord[eo],translation:te.translations[eo]},isTTSPlaying:eB&&"e"==eV,onTTSPlay:e=>{eM(),eu&&eO.sendAction({type:"SAY",text_stream:null!=e?e:eu,id:"e"})},isPracticeRecording:X,setPracticeRecording:e=>{e?K():Z()},isPracticePlaying:$,setPracticePlaying:e=>{e?J():z()},onSave:null!=em?em:void 0,isSaved:"message"===ec?eD.saved[eo]:"suggestion"===ec?te.saved[eo]:void 0}),(0,s.jsx)(A,{isOpen:ts,onClose:()=>{tl(!1)},isVoiceDetected:eY,selectedMic:eK,acquireMic:eX}),(0,s.jsx)(_,{isOpen:null!==eT,onClose:()=>{eC(null)},inputBar:(0,s.jsx)(E.y,{onStartPress:()=>{eZ(),eq(!1)},onEndPress:()=>{if(null===eT){console.error("Redo message index is null");return}eI.sendAction({type:"RESET_TO_MESSAGE",index:eT}),eG("l".concat(eT-1)),eJ(),eM(),setTimeout(()=>{eC(null)},100)},onTap:ea,onCancel:()=>{ez()},leftToggle:(0,s.jsx)("div",{}),rightToggle:(0,s.jsx)("div",{})})}),(0,s.jsx)(F,{isOpen:ew,onClose:()=>eN(!1)}),(0,s.jsx)(I,{isOpen:eF,onClose:()=>e_(!1),onFinish:()=>{eD.sendAction({type:"STOP_CALL",cancelled:!1})},streakPlus:eD.showStreakPlus,xp:eD.xp,words:e0.filter(e=>"user"===e.role).reduce((e,t)=>"string"!=typeof t.content?e:e+t.content.split(" ").length,0),minutes:Math.ceil((new Date().getTime()-new Date(eD.startTime).getTime())/1e3/60),session_id:Y}),(0,s.jsx)(R,{isOpen:eA,onClose:()=>eE(!1),onQuit:()=>{eD.sendAction({type:"STOP_CALL",cancelled:!0}),eg.replace("/")}}),(0,s.jsx)("div",{className:"flex w-full flex-col items-center px-7 pb-2",children:(0,s.jsx)(x.E.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{duration:.3},className:"w-full",children:(0,s.jsxs)("div",{className:"flex w-full items-center justify-between px-1",children:[(0,s.jsx)("button",{className:"flex h-12 items-center justify-center self-start rounded-full text-black",onClick:()=>{console.log("audioCall.showStreakPlus",eD.showStreakPlus),ep(!1),ee>=1?e_(!0):eE(!0)},children:(0,s.jsx)(y._0w,{className:"text-xl"})}),(0,s.jsx)("div",{className:"mx-5 h-1.5 w-full flex-grow overflow-hidden rounded-full bg-[#D9D9D9]",children:(0,s.jsx)("div",{className:"h-full rounded-full bg-[#2552F4] transition-all duration-300 ease-out",style:{width:"".concat(100*ee,"%")}})}),(0,s.jsx)("button",{className:"flex h-12 items-center justify-center self-start rounded-full text-black/30",onClick:()=>{tl(!0)},children:(0,s.jsx)(y.F1m,{className:"text-xl"})})]})})}),ek&&(0,s.jsxs)("div",{className:"flex w-full flex-grow flex-col gap-16 overflow-auto overscroll-contain px-5 pb-0 pt-0",children:[e6.length>1&&(0,s.jsx)("div",{className:"flex flex-col gap-5",children:(0,s.jsx)(B,{messages:e6.slice(0,-1),onlyWhiteboard:!0,...ti})}),(0,s.jsxs)("div",{className:"flex h-full max-h-full w-full flex-none flex-col items-center justify-between gap-5 py-5",children:[(0,s.jsxs)("div",{className:"flex min-h-0 w-full grow flex-col items-center justify-around rounded-3xl border-[1px] border-black/10 bg-white px-4 py-5 transition-all duration-300 ease-in-out",children:[(0,s.jsx)("div",{className:"rounded-sm bg-[#2552F4]/10 px-2 py-1 font-medium text-[#2552F4]",onClick:()=>{var e;return null===(e=Q.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},children:"Whiteboard"}),(0,s.jsx)("div",{className:"my-5 flex h-full w-full flex-col items-center justify-around overflow-y-scroll",children:e7&&(0,s.jsx)(O.ZP,{funcCall:e7.tool_calls[0].function,onTTSPlay:e=>{eM(),eO.sendAction({type:"SAY",text_stream:e,id:"w"})},isTTSPlaying:eB&&"w"==eV})})]}),e0.length>0&&(0,s.jsxs)("div",{className:"flex w-full items-center justify-center gap-4 pb-1",onClick:()=>{let e=e0.findLastIndex(e=>"assistant"===e.role);if(-1!==e){let t=e0[e];if("string"!=typeof t.content)return;eB&&eV==="r".concat(e)?eO.sendAction({type:"STOP",id:"r".concat(e)}):(eM(),eO.sendAction({type:"SAY",text_stream:t.content,id:"r".concat(e)}))}},children:["string"==typeof(null===(c=eD.lessonInfo)||void 0===c?void 0:null===(o=c.tutor)||void 0===o?void 0:o.profile_picture_url)?(0,s.jsx)("img",{src:null===(b=eD.lessonInfo)||void 0===b?void 0:null===(d=b.tutor)||void 0===d?void 0:d.profile_picture_url,className:"h-7 w-7 rounded-full transition-all duration-300 ease-in-out"}):null===(C=eD.lessonInfo)||void 0===C?void 0:null===(w=C.tutor)||void 0===w?void 0:w.profile_picture_url,(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"max-h-[4em] min-w-0 flex-1 overflow-y-auto text-sm text-black/50",children:[(()=>{if("string"!=typeof(null==e2?void 0:e2.content))return"\uD83D\uDD0A";let e=null==e2?void 0:e2.content,t=eB&&"r".concat(e1.toString())===eV,n=e$&&"l".concat(e1.toString())===eV,s=t||n;if(s){var l;null===(l=q.current)||void 0===l||l.scrollIntoView({behavior:"instant"})}return s?eU(e):e})(),(0,s.jsx)("div",{ref:q})]}),(0,s.jsx)("div",{className:"h-0 min-w-0 flex-1 text-sm text-black/50",style:{display:"-webkit-box",WebkitBoxOrient:"vertical",WebkitLineClamp:2,overflow:"hidden",textOverflow:"ellipsis",textAlign:"left"},children:(()=>{let e=e0.findLastIndex(e=>"assistant"===e.role),t=e0[e];return"string"!=typeof(null==t?void 0:t.content)?"\uD83D\uDD0A":null==t?void 0:t.content})()})]})]})]}),(0,s.jsx)("div",{className:"-mt-16",ref:Q})]}),(0,s.jsxs)("div",{className:"scrollbar-hide w-full flex-grow overflow-y-scroll overscroll-contain px-7 pt-[1px] ".concat(ek?"hidden":""),style:{overflowAnchor:"none"},ref:tt,children:["Realtime"!==eD.mode&&e4.length>0&&(0,s.jsx)(B,{messages:e4,...ti}),"Realtime"!==eD.mode&&(0,s.jsx)("div",{style:{height:null!=tn?tn:"auto"},className:"pt-[1px]",id:"latest-user-message",children:(0,s.jsx)(B,{messages:e5,indexOffset:e4.length,...ti})}),"Realtime"==eD.mode&&(0,s.jsxs)("div",{className:"flex h-full flex-col items-center justify-center",children:[(0,s.jsxs)("div",{className:"mb-16 flex w-full flex-col items-center gap-2 rounded-xl border-[1px] border-black/10 bg-white py-6",children:[(0,s.jsx)("img",{src:null===(D=eD.lessonInfo)||void 0===D?void 0:null===(k=D.tutor)||void 0===k?void 0:k.profile_picture_url,alt:"",className:"h-20 w-20"}),(0,s.jsx)("div",{className:"text-lg font-medium",children:null===(M=eD.lessonInfo)||void 0===M?void 0:null===(P=M.lesson)||void 0===P?void 0:P.title}),(0,s.jsx)("div",{className:"text-3xl",children:null===(W=eD.lessonInfo)||void 0===W?void 0:null===(V=W.lesson)||void 0===V?void 0:V.emoji}),(0,s.jsx)("div",{className:"rounded-md bg-[#0039FF]/10 p-2 text-[#0039FF]",children:"Real time call"})]}),(0,s.jsx)("div",{className:"mx-8 text-center text-sm text-black/30",children:"Caution: This mode is experimental and may not work as expected."})]}),(0,s.jsx)("div",{ref:H})]}),(0,s.jsxs)("div",{className:"pointer-events-none w-full justify-end gap-5 tracking-[-0.02em]",children:[(0,s.jsx)(u.M,{children:el&&(0,s.jsx)(x.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"scrollbar-hide pointer-events-auto flex w-full flex-nowrap justify-center gap-2 overflow-x-auto py-3",children:(0,s.jsx)("div",{className:"rounded-lg bg-red-600/10 p-1.5 px-2 text-center text-red-600",children:"Please press and hold the button to speak."})})}),(0,s.jsxs)("div",{className:"pointer-events-auto flex ".concat("Smart"==eD.mode&&"h-36"," w-full flex-col items-center justify-center gap-4 pb-10 pt-4 ").concat("Realtime"==eD.mode?"":"rounded-t-[2rem] border-[1px] border-black/10 bg-white"),children:[(0,s.jsx)(u.M,{mode:"wait",children:!en||"Smart"===eD.mode||eH||ek?e0.length>0&&"Realtime"!==eD.mode&&"Smart"!==eD.mode&&"Advanced"!==eD.mode?(0,s.jsxs)(x.E.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},children:[(0,s.jsx)("div",{className:"mb-1 flex justify-center text-base font-light text-black/30",onClick:()=>{ej(!ev)},children:(0,s.jsx)(x.E.div,{animate:{rotateX:ev?0:180},transition:{duration:.6,ease:"easeInOut"},children:(0,s.jsx)(y.RiI,{className:"scale-y-75 transform"})})}),(0,s.jsx)(u.M,{children:ev&&(0,s.jsx)(x.E.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3,ease:"easeInOut",opacity:{duration:.05,ease:"easeInOut"},height:{duration:.3,ease:"easeInOut"}},className:"overflow-hidden",children:(0,s.jsx)("div",{className:"h-32",children:(0,s.jsx)(m.tq,{pagination:!0,modules:[f.tl],className:"w-screen bg-white",children:(null===(G=te.suggestions)||void 0===G?void 0:G.length)>=3?te.suggestions.map((e,t)=>(0,s.jsx)(m.o5,{className:"mb-4 !h-auto px-6 py-2",children:(0,s.jsxs)("button",{onClick:()=>{ex(e),er(t),ed("suggestion"),ef(()=>e=>{console.log("saving suggestion"),te.sendAction({type:e?"DELETE_SUGGESTION":"SAVE_SUGGESTION",index:t})})},className:"flex h-full w-full flex-col items-center rounded-lg bg-white p-4 shadow-custom-shadow",children:["Intermediate"===eD.mode||"Advanced"===eD.mode?(0,s.jsx)("div",{className:"flex flex-wrap gap-1 gap-y-5",children:te.wordForWord[t]&&te.wordForWord[t].length>0&&te.wordForWord[t].map((e,t)=>(0,s.jsx)("div",{className:"flex flex-col items-center",children:(0,s.jsx)("div",{className:"mb-1 text-nowrap rounded-sm bg-black/5 px-1 font-normal text-black/0",children:e.original})},t))}):(0,s.jsx)("div",{className:"w-full overflow-hidden overflow-ellipsis whitespace-nowrap",children:(0,j.f)(e)}),(0,s.jsx)("div",{className:"w-full overflow-hidden overflow-ellipsis whitespace-nowrap text-sm text-black/30",children:(0,j.f)(te.translations[t])})]})},t)):(0,s.jsx)(s.Fragment,{children:Array.from({length:3}).map((e,t)=>(0,s.jsx)(m.o5,{className:"mb-4 !h-auto px-6 py-2",children:(0,s.jsx)("div",{className:"h-full w-full rounded-lg bg-white p-4 shadow-custom-shadow",children:(0,s.jsxs)("div",{className:"flex w-full flex-col items-center space-y-2",children:[(0,s.jsx)("div",{className:"animate-shimmer h-5 w-2/3 rounded bg-gray-200"}),(0,s.jsx)("div",{className:"animate-shimmer h-5 w-2/3 rounded bg-gray-200"})]})})},t))})})})})})]},"messages"):null:(0,s.jsxs)(x.E.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{duration:.3},className:"flex h-[10.75rem] flex-col items-center justify-center gap-5",children:[(0,s.jsx)(x.E.div,{initial:{y:-20},animate:{y:0},transition:{delay:.1,type:"spring",stiffness:300},className:"flex gap-2",children:[0,1,2].map(e=>(0,s.jsx)(x.E.div,{initial:{opacity:0,rotate:-180},animate:{opacity:1,rotate:0},transition:{delay:.1*e,duration:.3},children:(0,s.jsx)(y.QJe,{className:"text-[#0039FF]"})},e))}),(0,s.jsx)(x.E.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.4,duration:.3},children:"Amazing \uD83E\uDD73"})]},"encouragement")}),"CONNECTED"!==eD.status?(0,s.jsx)("button",{className:"flex hidden h-[3.6rem] flex-grow items-center justify-center rounded-full border-none px-4 font-bold text-[#2552F4]/80",onClick:()=>{eh||(ep(!0),eM(()=>{eD.sendAction({type:"START_CALL"})},()=>{alert("Failed to start speaker")}),"Realtime"==eD.mode&&eZ(),eq(!1))},children:(0,s.jsx)(y.fCD,{className:"animate-spin"})}):"Realtime"==eD.mode?(0,s.jsxs)("div",{className:"mx-8 flex w-full items-center justify-between",children:[(0,s.jsxs)("button",{className:"relative flex h-14 w-14 items-center justify-center rounded-full bg-black/5 ".concat(eY?"ring-4":""," ").concat(eQ?"ring-red-500/70":"ring-green-500/70"),onClick:()=>{eM(),eH||eZ(),eq(!eQ)},children:[(0,s.jsx)(N.J,{icon:eQ?y.uYL:y.RgM,className:"text-xl text-black"}),eY&&eQ&&(0,s.jsx)("p",{className:"absolute -right-[120px] -top-8 rounded-full rounded-bl-none bg-black/5 p-2 text-sm",children:"Press to unmute"})]}),(0,s.jsx)("button",{className:"flex h-14 w-14 items-center justify-center rounded-full bg-black/5",onClick:()=>{ep(!1),eD.sendAction({type:"STOP_CALL"}),console.log("audioCall.showStreakPlus",eD.showStreakPlus),eg.replace("/feedback?session_id=".concat(Y))},children:(0,s.jsx)(y._0w,{className:"text-xl text-black"})})]}):"Smart"==eD.mode?(0,s.jsx)(x.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:(0,s.jsx)(E.y,{onStartPress:()=>{eZ(),eq(!1)},onEndPress:()=>{eJ(),eM()},onCancel:()=>{ez()},onTap:ea,leftToggle:(0,s.jsx)("div",{children:(0,s.jsx)("div",{className:"flex h-14 w-14 items-center justify-center rounded-full ".concat(ey?"bg-black/5":"bg-[#2552F4]/10 text-[#2552F4]"),onClick:()=>{let e=e0.filter(e=>"assistant"===e.role&&"string"==typeof e.content).slice(-1)[0];e&&(eB&&"rLatest"===eV?eO.sendAction({type:"STOP",id:"rLatest"}):(eM(),eO.sendAction({type:"SAY",text_stream:e.content,id:"rLatest"})))},children:eB&&"rLatest"===eV?(0,s.jsx)(y.u9M,{}):(0,s.jsx)(y.YRv,{})})}),rightToggle:(0,s.jsx)("div",{children:(0,s.jsx)("button",{className:"flex h-14 w-14 items-center justify-center rounded-full text-xl ".concat(ek?"bg-[#2552F4]/10 text-[#2552F4]":"bg-black/5"),onClick:()=>{eS(!ek),ek||(ej(!1),setTimeout(()=>{var e;null===(e=Q.current)||void 0===e||e.scrollIntoView({behavior:"smooth",block:"end",inline:"end"})},1)),ek&&setTimeout(()=>{var e;null===(e=H.current)||void 0===e||e.scrollIntoView({behavior:"smooth",block:"end",inline:"end"})},1)},children:(0,s.jsx)(y.$e0,{})})})})}):(0,s.jsx)(E.y,{onStartPress:()=>{eZ(),eq(!1)},onEndPress:()=>{eJ(),eM()},onTap:ea,onCancel:()=>{ez()},leftToggle:(0,s.jsx)("div",{children:void 0!==ey&&eb&&(0,s.jsx)("div",{className:"flex h-14 w-14 items-center justify-center rounded-full ".concat(ey?"bg-black/5":"bg-[#0039FF]/10 text-[#0039FF]"),onClick:()=>{eb(!ey)},children:(0,s.jsx)(y.Vbz,{})})}),rightToggle:(0,s.jsx)("div",{children:void 0!==ew&&eN&&(0,s.jsx)("button",{className:"flex h-14 w-14 items-center justify-center rounded-full bg-black/5",onClick:()=>{eN(!ew)},children:(0,s.jsx)(S,{})})})})]})]})]})}let B=e=>{let{messages:t,indexOffset:n=0,onlyWhiteboard:l=!1,isPlaying:i,latestAudioId:a,isPreviewTTSPlaying:o,translation:r,audioCall:c,startSpeaker:d,tts:u,sliceTTS:x,correction:m,viewText:f,setExplainedOriginal:h,setOpenedExplanation:p,setOpenedExplanationType:g,setOnExplanationSave:v,setRedoMessageIndex:j}=e;return(0,s.jsx)(s.Fragment,{children:t.map((e,t)=>{var y,b,w,N,T;let S=t+n,A=i&&"r".concat(S.toString())===a,E=o&&"l".concat(S.toString())===a,F=A||E,_="Advanced"===c.mode||"Smart"===c.mode||!f||"string"!=typeof e.content;if((null==e?void 0:e.role)==="assistant")return(0,s.jsxs)("div",{children:[e.content&&!l&&(0,s.jsx)(C.nQ,{profilePicture:null===(b=c.lessonInfo)||void 0===b?void 0:null===(y=b.tutor)||void 0===y?void 0:y.profile_picture_url,isPlaying:F,message:"Advanced"!==c.mode&&f?"string"!=typeof e.content?"\uD83D\uDD0A":F?x(e.content):e.content:void 0,translation:_?void 0:F?x(r.translations[S],e.content):r.translations[S],onTap:()=>{E||"string"!=typeof e.content||(r.sendAction({type:"REQUEST_WORD_FOR_WORD",index:S}),h(e.content),p(S),g("message"),v(()=>e=>{c.sendAction({type:e?"DELETE_MESSAGE":"SAVE_MESSAGE",index:S})}))},onTTSPlay:()=>{d(),u.sendAction({type:"SAY",text_stream:null==e?void 0:e.content,id:"r".concat(S)})},onTTSStop:()=>{d(),u.sendAction({type:"STOP",id:"r".concat(S)})},onTranslate:_?void 0:e=>{e&&(r.translations[S]||r.sendAction({type:"REQUEST_TRANSLATION",index:S}))},defaultShowTranslation:"Beginner"===c.mode||"Smart"===c.mode}),e.tool_calls&&(null===(N=e.tool_calls[0])||void 0===N?void 0:null===(w=N.function)||void 0===w?void 0:w.name)&&!L.includes(e.tool_calls[0].function.name)&&(0,s.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1 text-sm text-[#2552F4]/80",children:[(0,s.jsx)("div",{className:"rounded-lg bg-[#2552F4]/10 p-1.5",children:(0,s.jsx)(k.jLr,{className:"text-sm text-[#2552F4]/80"})}),(0,s.jsx)("div",{className:"font-base text-sm font-extrabold",children:null!==(T=e.tool_calls[0].function.name.replaceAll("_"," ").toUpperCase())&&void 0!==T?T:"Whiteboard"})]}),(0,s.jsx)("div",{className:"mb-6 flex flex-col items-center justify-around rounded-3xl border border-black/10 bg-white p-10",children:(0,s.jsx)(O.ZP,{funcCall:e.tool_calls[0].function,onTTSPlay:e=>{d(),u.sendAction({type:"SAY",text_stream:e,id:"w".concat(S)})},isTTSPlaying:i&&a=="w".concat(S),isCompact:!0})})]})]},S);if((null==e?void 0:e.role)==="user"&&!l){let t=m.corrections[S];return(0,s.jsx)("div",{children:(0,s.jsx)(C.MI,{message:"string"==typeof e.content?e.content:"\uD83D\uDD0A",translation:r.translations[S],correction:t,onTap:()=>{E||"string"!=typeof e.content||(r.sendAction({type:"REQUEST_WORD_FOR_WORD",index:S}),h(e.content),p(S),g("message"),v(()=>()=>{c.sendAction({type:"SAVE_MESSAGE",index:S})}))},onTranslate:e=>{e&&(r.translations[S]||r.sendAction({type:"REQUEST_TRANSLATION",index:S}))},onRedo:()=>{j(S)},defaultShowTranslation:"Beginner"===c.mode||"Smart"===c.mode})},S)}return null})})};function V(){return(0,l.useEffect)(()=>(document.body.style.backgroundColor="#FAFBFF",()=>{document.body.style.backgroundColor=""}),[]),(0,s.jsx)(d,{children:(0,s.jsx)("main",{className:"h-screen-safe bg-[#FAFBFF] pt-1",children:(0,s.jsx)(M,{})})})}},63399:function(e,t,n){"use strict";n.d(t,{Z:function(){return a}});var s=n(2265),l=n(74272),i=n(56870);function a(e){let{onPlaybackStart:t,onPlaybackFinish:n,onPlaybackInterrupt:a,volume:o=1,speed:r=1}=e,c=(0,s.useContext)(l.Dm),d=(0,i.Y)(),u=(0,s.useRef)([]),x=(0,s.useRef)(0),m=(0,s.useRef)(null),f=(0,s.useRef)([]),h=(0,s.useRef)(null),p=(0,s.useRef)(null),g=(0,s.useRef)(!1),[v,j]=(0,s.useState)(!1),y=(0,s.useRef)(v),[b,w]=(0,s.useState)(!1),[N,T]=(0,s.useState)(null),C=(0,s.useRef)(null),[k,S]=(0,s.useState)(null),A=(0,s.useRef)(null),E=()=>{F(),null!==p.current&&(p.current.disconnect(),p.current=null,console.log("Phase vocoder node disconnected and released")),null!==h.current&&(h.current.disconnect(),h.current=null,console.log("Gain node disconnected and released"))},F=()=>{if(f.current.forEach(e=>{clearTimeout(e)}),f.current=[],m.current&&(clearTimeout(m.current),m.current=null),0===u.current.length)return;let e=1,t=u.current.slice(0,5);for(let n of t)if(n&&n.buffer){let t=n.buffer.getChannelData(0);for(let n=0;n<t.length;n++)t[n]=t[n]*e,e-=1/(5*t.length)}u.current.slice(5).forEach(e=>{e.onended=null,e.stop()}),j(!1),y.current=!1;let n=d.currentTime-x.current;null==a||a(C.current,n,k),u.current=t},_=()=>{j(!1),y.current=!1,w(!1),f.current=[],A.current=null,null==n||n(C.current)},R=async e=>{let{i:n,data:s,id:l,t:i}=e,a=new Int16Array(s),o=d.createBuffer(1,a.length,24e3),c=o.getChannelData(0);for(let e=0;e<a.length;e++)c[e]=a[e]/32768;if(null===h.current){console.error("Gain node not created yet"),alert("Speaker not ready yet, this should not happen");return}let p=d.createBufferSource();p.connect(h.current),p.playbackRate.value=r,p.buffer=o;let g=0==n;g&&(u.current.length>0&&F(),x.current=d.currentTime,console.log("Audio start time reset to",x.current));let v=x.current+.1*n/r+.1,b=d.currentTime-v;if(b>0&&(console.log("Audio chunk is late, delaying playback by ".concat(b," seconds.")),v+=b,x.current+=b),p.start(v),u.current.push(p),g&&(m.current=setTimeout(()=>{j(!0),y.current=!0,null==t||t(l),S(0),void 0==l&&console.error("First chunk must have an id"),T(l),C.current=l,m.current=null},-(1e3*b))),p.onended=()=>{u.current.length>0&&(u.current.shift(),w(!1)),A.current&&n==A.current-1?(console.log("Natural end of audio"),_()):0===u.current.length&&(console.log("Lagging, no more audio to play"),w(!0))},void 0!=i){let e=f.current.length,t=d.currentTime,n=i.map((n,s)=>setTimeout(()=>S(e+s),1e3*(x.current+n-t)/r));f.current.push(...n)}};return(0,s.useEffect)(()=>{if(!c){console.log("No session found!");return}return c.registerEvent("TTS_CHUNK",R),c.registerEvent("TTS_INTERRUPT",()=>{F()}),c.registerEvent("TTS_END",e=>{let{id:t,len:n}=e;A.current=n}),()=>{null==c||c.deregisterEvent("TTS_CHUNK"),null==c||c.deregisterEvent("TTS_INTERRUPT"),null==c||c.deregisterEvent("TTS_END")}},[c,r]),(0,s.useEffect)(()=>{h.current&&(h.current.gain.value=o)},[o]),(0,s.useEffect)(()=>{p.current&&(p.current.parameters.get("pitchFactor").value=1/r)},[r]),(0,s.useEffect)(()=>()=>{E()},[]),{isPlaying:v,isLagging:b,latestAudioId:N,setLatestAudioId:T,latestCharIndex:k,startSpeaker:(e,t)=>{if(d.resume(),null===h.current){if(g.current){console.log("Speaker is already initializing");return}g.current=!0;try{h.current=d.createGain(),console.log("Gain node created"),h.current.connect(d.destination),h.current.gain.value=o,console.log("Gain node connected to destination"),null==e||e()}catch(e){console.error("Failed to create speaker",e)}finally{g.current=!1}null===h.current&&(null==t||t())}},stopSpeaker:E}}}},function(e){e.O(0,[2284,7316,7240,1015,6051,7699,4060,9763,8802,1811,8351,2648,4436,5731,3069,8046,1859,7044,2971,2117,1744],function(){return e(e.s=93658)}),_N_E=e.O()}]);